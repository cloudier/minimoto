#!/usr/bin/python3

"""
The following is a sample usage of the client command. Assume a collection of
images are stored in ./sample_images and you have two S3 buckets:
au.edu.unsw.cs9243.input and au.edu.unsw.cs9243.output. (Note that the bucket
name is globally unique and you may not be able to create the buckets used in
this example, so create your own unique bucket names.)

    $ ./minimoto_client ./sample_images au.edu.unsw.cs9243.input au.edu.unsw.cs9243.output
    You'll find the output in s3://au.edu.unsw.cs9243.output/xyz.mp4
    $

The client does the following:

- Upload images in directory (e.g., ./sample_images) to the input S3 bucket
(e.g., au.edu.unsw.cs9243.input).
- After uploading all images, send a request (using an AWS Simple Queue Service
(SQS) queue) to start a transcoding job.
- Print a message containing the S3 URL of the video file that will be placed in
the output S3 bucket (e.g., au.edu.unsw.cs9243.output) when the job is done.
- If the optional --wait flag is given, then wait until transcoding has
completed and the output video file is ready for collection. If no --wait flag
is given, then exit without waiting; the user will find the output video file in
the output S3 bucket once transcoding has completed.
- Depending on the workload and the service capacity, uploaded images might not
be processed immediately. So, make sure not to overwrite images that were
previously uploaded. Adding a unique suffix to the directory name is one
solution (e.g., upload files to au.edu.unsw.cs9243.input/sample_images_xyz and
place the result in au.edu.unsw.cs9243.output/xyz.mp4 where xyz is a random
string).

The name of a video file can be arbitrary however it must be unique for each
request.

The output message specifying the S3 URL is mandatory. An S3 URL has the form
s3://<S3 bucket name>/<file path>. The client program may print out other
messages regarding its progress as well, it is up to you what those messages
are.
"""

import os
import sys
import boto3
import random
import string

from minimoto_constants import *

RANDOMWORD_LENGTH = 10


def randomword():
   return ''.join(random.choice(string.ascii_lowercase)
                  for i in range(RANDOMWORD_LENGTH))


def main():
    if len(sys.argv) < 4:
        print("Not enough arguments")
        exit(1)
    images_dir = os.path.normpath(sys.argv[1])
    s3_dirname = images_dir + "_" + randomword()
    input_bucket_name = sys.argv[2]
    output_bucket_name = sys.argv[3]
    wait_flag = False
    if len(sys.argv) == 5 and sys.argv[4] == "--wait":
        wait_flag = True

    print("Getting boto3 clients and resources")
    s3 = boto3.resource("s3")
    sqs = boto3.resource("sqs")

    print("Uploading images in {} to input bucket at {}".format(
          images_dir, s3_dirname))
    input_bucket = s3.Bucket(input_bucket_name)
    for image in os.listdir(images_dir):
        input_bucket.upload_file(os.path.join(images_dir, image),
                                 os.path.join(s3_dirname, image))

    print("Sending message to transcoding queue")
    queue = sqs.get_queue_by_name(QueueName=TRANSCODING_REQUESTS_QUEUE_NAME)
    queue.send_message(MessageBody=s3_dirname)

    if wait_flag:
        print("Waiting for transcoding to complete...")
        output_obj = s3.Object(output_bucket_name, s3_dirname + ".mp4")
        output_obj.wait_until_exists()
    print("You'll find the output in s3://{bucket_name}/{s3_dirname}.mp4"
          .format(bucket_name=output_bucket_name, s3_dirname=s3_dirname))


if __name__ == "__main__":
    main()

